# Shared server locations and rules for client-mx

# Block public access to Prometheus metrics
location ^~ /api/metrics {
  return 404;
  access_log off;
}

# Proxy API to internal Nest server
location /api/ {
  proxy_pass http://server-nest:8083;
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header Connection "";

  # Security headers at edge
  add_header X-Frame-Options DENY;
  add_header X-Content-Type-Options nosniff;
  add_header X-XSS-Protection "1; mode=block";
}

# Cache static assets
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
  expires 1y;
  add_header Cache-Control "public, immutable";
}

# NGINX status endpoint for monitoring
location /nginx_status {
  stub_status on;
  access_log off;
  allow 127.0.0.1;
  allow 172.16.0.0/12; # Docker network
  deny all;
}

# Handle client-side routing (SPA)
location / {
  try_files $uri $uri/ /index.html;
}
